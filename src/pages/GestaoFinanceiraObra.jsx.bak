/**
 * MONTEX ERP Premium - Gestão Financeira da Obra
 *
 * Sistema completo de controle financeiro com:
 * - Dashboard com saldo em tempo real
 * - Lançamentos de despesas
 * - Material faturado direto
 * - Medições (Fabricação/Montagem)
 * - Saldo restante automático
 * - Fluxo de caixa
 */

import React, { useState, useMemo, useCallback } from 'react';
import { motion } from 'framer-motion';
import {
  DollarSign,
  TrendingUp,
  FileText,
  Package,
  Truck,
  Plus,
  Search,
  Filter,
  CheckCircle2,
  Clock,
  AlertTriangle,
  XCircle,
  Eye,
  Download,
  ChevronDown,
  BarChart3,
  PieChart as PieChartIcon,
  ArrowUpRight,
  ArrowDownRight,
  Receipt,
  Wallet,
  Weight,
  Target,
  Activity,
  Layers,
  ClipboardList,
  ArrowRight,
  Check,
  Info
} from 'lucide-react';
import * as Tabs from '@radix-ui/react-tabs';
import * as Select from '@radix-ui/react-select';
import * as Dialog from '@radix-ui/react-dialog';
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
  Line,
  ComposedChart
} from 'recharts';

import {
  TIPO_LANCAMENTO,
  STATUS_LANCAMENTO,
  STATUS_PEDIDO_FUTURO,
  CATEGORIA_DESPESA,
  STATUS_MEDICAO,
  ETAPA_MEDICAO,
  TIPO_RECEITA,
  STATUS_MATERIAL,
  OBRA_MODELO,
  LANCAMENTOS_DESPESAS,
  PEDIDOS_PRE_APROVADOS,
  MEDICOES_RECEITAS,
  COMPOSICAO_CONTRATO,
  MEDICOES,
  PEDIDOS_MATERIAL,
  calcularSaldoObra,
  calcularDespesasPorCategoria,
  calcularFluxoCaixa,
  calcularResumoPedidosFuturos,
  calcularAnaliseProjecao,
  calcularFluxoCaixaComFuturos,
  calcularSaldoContratoComReceitas,
  calcularDREObra,
  calcularResumoMateriais,
  calcularEstoquePorTipo
} from '../data/obraFinanceiraDatabase';
import { useObras } from '../contexts/ERPContext';

// Formatação monetária brasileira completa (ex: 2.700.000,00)
const formatMoney = (valor) => {
  if (valor === undefined || valor === null || isNaN(valor)) return '0,00';
  return valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
};

// Formatação monetária sem centavos para valores grandes
const formatMoneyShort = (valor) => {
  if (valor === undefined || valor === null || isNaN(valor)) return '0';
  return Math.round(valor).toLocaleString('pt-BR');
};

// Cores
const COLORS = ['#06b6d4', '#8b5cf6', '#f59e0b', '#10b981', '#ef4444', '#ec4899', '#3b82f6', '#14b8a6'];

const STATUS_COLORS = {
  [STATUS_LANCAMENTO.PENDENTE]: { bg: 'bg-amber-500/20', text: 'text-amber-400', border: 'border-amber-500/30' },
  [STATUS_LANCAMENTO.APROVADO]: { bg: 'bg-blue-500/20', text: 'text-blue-400', border: 'border-blue-500/30' },
  [STATUS_LANCAMENTO.PAGO]: { bg: 'bg-emerald-500/20', text: 'text-emerald-400', border: 'border-emerald-500/30' },
  [STATUS_LANCAMENTO.CANCELADO]: { bg: 'bg-slate-500/20', text: 'text-slate-400', border: 'border-slate-500/30' },
  [STATUS_LANCAMENTO.FATURADO]: { bg: 'bg-purple-500/20', text: 'text-purple-400', border: 'border-purple-500/30' }
};

const MEDICAO_STATUS_COLORS = {
  [STATUS_MEDICAO.AGUARDANDO]: { bg: 'bg-slate-500/20', text: 'text-slate-400', icon: Clock },
  [STATUS_MEDICAO.EM_ANALISE]: { bg: 'bg-amber-500/20', text: 'text-amber-400', icon: Eye },
  [STATUS_MEDICAO.APROVADA]: { bg: 'bg-blue-500/20', text: 'text-blue-400', icon: CheckCircle2 },
  [STATUS_MEDICAO.FATURADA]: { bg: 'bg-purple-500/20', text: 'text-purple-400', icon: Receipt },
  [STATUS_MEDICAO.PAGA]: { bg: 'bg-emerald-500/20', text: 'text-emerald-400', icon: DollarSign },
  [STATUS_MEDICAO.REJEITADA]: { bg: 'bg-red-500/20', text: 'text-red-400', icon: XCircle }
};

const CATEGORIA_LABELS = {
  [CATEGORIA_DESPESA.MATERIAL_ESTRUTURA]: 'Material Estrutura',
  [CATEGORIA_DESPESA.MATERIAL_COBERTURA]: 'Material Cobertura',
  [CATEGORIA_DESPESA.MATERIAL_FECHAMENTO]: 'Material Fechamento',
  [CATEGORIA_DESPESA.MATERIAL_COMPLEMENTOS]: 'Material Complementos',
  [CATEGORIA_DESPESA.MAO_DE_OBRA_FABRICA]: 'MO Fábrica',
  [CATEGORIA_DESPESA.MAO_DE_OBRA_MONTAGEM]: 'MO Montagem',
  [CATEGORIA_DESPESA.TERCEIRIZADOS]: 'Terceirizados',
  [CATEGORIA_DESPESA.TRANSPORTE]: 'Transporte',
  [CATEGORIA_DESPESA.PINTURA]: 'Pintura',
  [CATEGORIA_DESPESA.CONSUMIVEIS]: 'Consumíveis',
  [CATEGORIA_DESPESA.OUTROS]: 'Outros'
};

// Componente KPI Card
const KPICard = ({ icon: Icon, label, value, subvalue, color, trend, highlight = false }) => (
  <motion.div
    initial={{ opacity: 0, y: 20 }}
    animate={{ opacity: 1, y: 0 }}
    className={`bg-gradient-to-br from-slate-800/80 to-slate-900/80 backdrop-blur-xl
               rounded-xl border p-4 relative overflow-hidden
               ${highlight ? `border-${color}-500/50` : 'border-slate-700/50'}`}
  >
    {highlight && (
      <div className={`absolute inset-0 bg-${color}-500/5`} />
    )}
    <div className="relative">
      <div className="flex items-start justify-between">
        <div className={`p-2 bg-${color}-500/20 rounded-lg`}>
          <Icon className={`w-5 h-5 text-${color}-400`} />
        </div>
        {trend !== undefined && (
          <span className={`flex items-center text-xs ${trend >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
            {trend >= 0 ? <ArrowUpRight className="w-3 h-3" /> : <ArrowDownRight className="w-3 h-3" />}
            {Math.abs(trend).toFixed(1)}%
          </span>
        )}
      </div>
      <p className="text-xs text-slate-400 mt-3">{label}</p>
      <p className={`text-xl font-bold ${highlight ? `text-${color}-400` : 'text-white'}`}>{value}</p>
      {subvalue && <p className="text-xs text-slate-500">{subvalue}</p>}
    </div>
  </motion.div>
);

// Componente Progress Bar
const ProgressBar = ({ value, max, color = 'cyan', showLabel = true, height = 'h-2' }) => {
  const percentage = max > 0 ? (value / max) * 100 : 0;
  return (
    <div className="w-full">
      <div className={`${height} bg-slate-700 rounded-full overflow-hidden`}>
        <motion.div
          initial={{ width: 0 }}
          animate={{ width: `${Math.min(percentage, 100)}%` }}
          transition={{ duration: 0.8 }}
          className={`h-full bg-${color}-500 rounded-full`}
        />
      </div>
      {showLabel && (
        <div className="flex justify-between mt-1 text-xs text-slate-400">
          <span>Pago: R$ {formatMoney(value)}</span>
          <span>{percentage.toFixed(1)}%</span>
        </div>
      )}
    </div>
  );
};

export default function GestaoFinanceiraObra() {
  // ERPContext - lista de obras para filtro
  const { obras: obrasERP, obraAtualData } = useObras();

  // Estados
  const [obra, setObra] = useState(OBRA_MODELO);
  const [obraFiltro, setObraFiltro] = useState(OBRA_MODELO.id);
  const [lancamentos, setLancamentos] = useState(LANCAMENTOS_DESPESAS);
  const [pedidosFuturos, setPedidosFuturos] = useState(PEDIDOS_PRE_APROVADOS);
  const [medicoesReceitas, setMedicoesReceitas] = useState(MEDICOES_RECEITAS);
  const [composicaoContrato, setComposicaoContrato] = useState(COMPOSICAO_CONTRATO);
  const [medicoes, setMedicoes] = useState(MEDICOES);
  const [materiais, setMateriais] = useState(PEDIDOS_MATERIAL);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [filtroCategoria, setFiltroCategoria] = useState('todas');
  const [filtroStatus, setFiltroStatus] = useState('todos');
  const [searchTerm, setSearchTerm] = useState('');
  const [showNovoLancamento, setShowNovoLancamento] = useState(false);
  const [showNovaMedicao, setShowNovaMedicao] = useState(false);
  const [setorSelecionado, setSetorSelecionado] = useState('todos');
  const [viewMode, setViewMode] = useState('real'); // 'real', 'futuro', 'projecao'

  // Cálculos principais
  const saldo = useMemo(() =>
    calcularSaldoObra(obra, lancamentos, medicoes),
    [obra, lancamentos, medicoes]
  );

  const despesasPorCategoria = useMemo(() =>
    calcularDespesasPorCategoria(lancamentos, obra.id),
    [lancamentos, obra.id]
  );

  const fluxoCaixa = useMemo(() =>
    calcularFluxoCaixa(lancamentos, medicoes, 6),
    [lancamentos, medicoes]
  );

  // Análise de pedidos futuros
  const resumoFuturos = useMemo(() =>
    calcularResumoPedidosFuturos(pedidosFuturos, obra.id),
    [pedidosFuturos, obra.id]
  );

  // Análise comparativa REAL vs FUTURO
  const analiseProjecao = useMemo(() =>
    calcularAnaliseProjecao(obra, lancamentos, pedidosFuturos, medicoes),
    [obra, lancamentos, pedidosFuturos, medicoes]
  );

  // Fluxo de caixa com futuros incluídos
  const fluxoCaixaComFuturos = useMemo(() =>
    calcularFluxoCaixaComFuturos(lancamentos, medicoes, pedidosFuturos, 6),
    [lancamentos, medicoes, pedidosFuturos]
  );

  // Calcular totais dos lançamentos reais pagos
  const totalPago = useMemo(() =>
    lancamentos
      .filter(l => l.status === STATUS_LANCAMENTO.PAGO)
      .reduce((sum, l) => sum + l.valor, 0),
    [lancamentos]
  );

  // Calcular saldo do contrato com receitas (medições pagas)
  const saldoContrato = useMemo(() =>
    calcularSaldoContratoComReceitas(obra, medicoesReceitas),
    [obra, medicoesReceitas]
  );

  // Calcular DRE da obra
  const dreObra = useMemo(() =>
    calcularDREObra(obra, lancamentos, medicoesReceitas),
    [obra, lancamentos, medicoesReceitas]
  );

  // Calcular resumo de materiais (Pedido x Entrega)
  const resumoMateriais = useMemo(() =>
    calcularResumoMateriais(materiais, obra.id),
    [materiais, obra.id]
  );

  // Calcular estoque por tipo de material
  const estoquePorTipo = useMemo(() => {
    const porTipo = calcularEstoquePorTipo(materiais, obra.id);
    // Converter objeto para array com tipoLabel
    return Object.entries(porTipo).map(([tipo, dados]) => ({
      tipo,
      tipoLabel: tipo.replace(/_/g, ' '),
      ...dados
    }));
  }, [materiais, obra.id]);

  // Total de receitas realizadas
  const totalReceitasRealizadas = useMemo(() =>
    medicoesReceitas
      .filter(r => r.status === STATUS_MEDICAO.PAGA)
      .reduce((sum, r) => sum + r.valorBruto, 0),
    [medicoesReceitas]
  );

  // Filtros de lançamentos
  const lancamentosFiltrados = useMemo(() => {
    return lancamentos.filter(l => {
      const matchCategoria = filtroCategoria === 'todas' || l.categoria === filtroCategoria;
      const matchStatus = filtroStatus === 'todos' || l.status === filtroStatus;
      const matchSearch = !searchTerm ||
        l.descricao?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        l.fornecedor?.toLowerCase().includes(searchTerm.toLowerCase());
      const matchSetor = setorSelecionado === 'todos' || l.setor === setorSelecionado;
      return matchCategoria && matchStatus && matchSearch && matchSetor;
    });
  }, [lancamentos, filtroCategoria, filtroStatus, searchTerm, setorSelecionado]);

  // Dados para gráficos
  const dadosCategoria = useMemo(() => {
    return Object.entries(despesasPorCategoria)
      .filter(([_, data]) => data.total > 0)
      .map(([cat, data], idx) => ({
        name: CATEGORIA_LABELS[cat] || cat,
        value: data.total,
        color: COLORS[idx % COLORS.length]
      }))
      .sort((a, b) => b.value - a.value)
      .slice(0, 8);
  }, [despesasPorCategoria]);

  const dadosMedicoes = useMemo(() => {
    return obra.setores.map(setor => {
      const medicoesFab = medicoes.filter(m =>
        m.setor === setor.nome && m.etapa === ETAPA_MEDICAO.FABRICACAO
      );
      const medicoesMont = medicoes.filter(m =>
        m.setor === setor.nome && m.etapa === ETAPA_MEDICAO.MONTAGEM
      );

      const medidoFab = medicoesFab.reduce((s, m) => s + m.pesoMedido, 0);
      const medidoMont = medicoesMont.reduce((s, m) => s + m.pesoMedido, 0);

      return {
        setor: setor.nome,
        peso: setor.peso,
        fabricacao: medidoFab,
        montagem: medidoMont,
        restante: setor.peso - medidoFab
      };
    });
  }, [obra.setores, medicoes]);

  // Adicionar lançamento
  const adicionarLancamento = useCallback((novoLanc) => {
    const lancamento = {
      id: `lanc-${Date.now()}`,
      obraId: obra.id,
      ...novoLanc,
      status: STATUS_LANCAMENTO.PENDENTE
    };
    setLancamentos(prev => [...prev, lancamento]);
    setShowNovoLancamento(false);
  }, [obra.id]);

  // Atualizar status lançamento
  const atualizarStatusLancamento = useCallback((id, novoStatus) => {
    setLancamentos(prev => prev.map(l =>
      l.id === id ? { ...l, status: novoStatus, dataPagamento: novoStatus === STATUS_LANCAMENTO.PAGO ? new Date().toISOString() : l.dataPagamento } : l
    ));
  }, []);

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-6">
      <div className="max-w-7xl mx-auto space-y-6">
        {/* Header */}
        <motion.div
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          className="flex items-center justify-between"
        >
          <div>
            <h1 className="text-3xl font-bold text-white flex items-center gap-3">
              <div className="p-3 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl">
                <DollarSign className="w-8 h-8 text-white" />
              </div>
              Gestão Financeira da Obra
            </h1>
            <p className="text-slate-400 mt-1">
              <span className="text-cyan-400 font-medium">{obra.codigo}</span> - {obra.nome}
              <span className="mx-2">•</span>
              <span className="text-emerald-400">{(obra.contrato.pesoTotal / 1000).toFixed(0)} ton</span>
            </p>
          </div>

          <div className="flex items-center gap-3">
            {/* Filtro por Obra */}
            <Select.Root value={obraFiltro} onValueChange={setObraFiltro}>
              <Select.Trigger className="flex items-center gap-2 px-4 py-2 bg-slate-800/50 border border-slate-700/50 rounded-xl text-white min-w-[220px]">
                <Filter className="w-4 h-4 text-cyan-400" />
                <Select.Value />
                <ChevronDown className="w-4 h-4 text-slate-400 ml-auto" />
              </Select.Trigger>
              <Select.Portal>
                <Select.Content className="bg-slate-800 border border-slate-700 rounded-xl shadow-2xl z-50">
                  <Select.Viewport className="p-2">
                    <Select.Item value={OBRA_MODELO.id} className="px-3 py-2 text-sm text-white hover:bg-slate-700 rounded-lg cursor-pointer outline-none">
                      <Select.ItemText>{OBRA_MODELO.codigo} - {OBRA_MODELO.nome}</Select.ItemText>
                    </Select.Item>
                    {obrasERP.filter(o => o.id !== OBRA_MODELO.id).map(o => (
                      <Select.Item key={o.id} value={o.id} className="px-3 py-2 text-sm text-white hover:bg-slate-700 rounded-lg cursor-pointer outline-none">
                        <Select.ItemText>{o.codigo} - {o.nome}</Select.ItemText>
                      </Select.Item>
                    ))}
                  </Select.Viewport>
                </Select.Content>
              </Select.Portal>
            </Select.Root>

            <div className="text-right mr-2">
              <p className="text-xs text-slate-400">Valor do Contrato</p>
              <p className="text-2xl font-bold text-white">
                R$ {formatMoney(obra.contrato.valorTotal)}
              </p>
            </div>
            <button className="flex items-center gap-2 px-4 py-2 bg-slate-800/50 border border-slate-700/50
                           text-slate-300 rounded-xl hover:bg-slate-700/50 transition-colors">
              <Download className="w-4 h-4" />
              Exportar
            </button>
          </div>
        </motion.div>

        {/* Saldo Restante Destacado */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="bg-gradient-to-r from-emerald-900/40 via-teal-900/30 to-cyan-900/40 backdrop-blur-xl
                   rounded-2xl border border-emerald-500/30 p-6"
        >
          <div className="grid grid-cols-1 md:grid-cols-7 gap-4">
            {/* Valor Contrato */}
            <div className="text-center">
              <p className="text-xs text-slate-400 mb-1">Valor Contrato</p>
              <p className="text-xl font-bold text-white">
                R$ {formatMoney(saldo.valorContrato)}
              </p>
              <p className="text-xs text-slate-500">100%</p>
            </div>

            {/* Seta */}
            <div className="hidden md:flex items-center justify-center">
              <ArrowRight className="w-5 h-5 text-slate-600" />
            </div>

            {/* Receitas Realizadas (Medições Pagas) */}
            <div className="text-center bg-emerald-900/20 rounded-xl p-2 border border-emerald-500/20">
              <p className="text-xs text-emerald-300 mb-1">RECEITAS PAGAS</p>
              <p className="text-xl font-bold text-emerald-400">
                R$ {formatMoney(totalReceitasRealizadas)}
              </p>
              <p className="text-xs text-emerald-500">{saldoContrato.percentualMedido.toFixed(1)}%</p>
            </div>

            {/* Seta */}
            <div className="hidden md:flex items-center justify-center">
              <ArrowRight className="w-5 h-5 text-slate-600" />
            </div>

            {/* Despesas Pagas */}
            <div className="text-center bg-red-900/20 rounded-xl p-2 border border-red-500/20">
              <p className="text-xs text-red-300 mb-1">DESPESAS PAGAS</p>
              <p className="text-xl font-bold text-red-400">
                R$ {formatMoney(totalPago)}
              </p>
              <p className="text-xs text-red-500">{((totalPago / saldo.valorContrato) * 100).toFixed(1)}%</p>
            </div>

            {/* Seta */}
            <div className="hidden md:flex items-center justify-center">
              <ArrowRight className="w-5 h-5 text-slate-600" />
            </div>

            {/* Saldo do Contrato (Abatido automaticamente) */}
            <div className="text-center bg-purple-900/30 rounded-xl p-2 border border-purple-500/30">
              <p className="text-xs text-purple-300 mb-1">SALDO CONTRATO</p>
              <p className="text-xl font-bold text-purple-400">
                R$ {formatMoney(saldoContrato.saldoRestante)}
              </p>
              <p className="text-xs text-purple-500">{saldoContrato.percentualRestante.toFixed(1)}% restante</p>
            </div>
          </div>

          {/* Barra de progresso geral */}
          <div className="mt-6">
            <div className="flex items-center justify-between text-xs text-slate-400 mb-2">
              <span>Progresso Financeiro</span>
              <span>{saldo.percentualMedido.toFixed(1)}% medido</span>
            </div>
            <div className="h-3 bg-slate-700 rounded-full overflow-hidden flex">
              <motion.div
                initial={{ width: 0 }}
                animate={{ width: `${saldo.percentualRecebido}%` }}
                className="bg-emerald-500 h-full"
                title="Recebido"
              />
              <motion.div
                initial={{ width: 0 }}
                animate={{ width: `${saldo.percentualMedido - saldo.percentualRecebido}%` }}
                className="bg-cyan-500 h-full"
                title="Medido (a receber)"
              />
            </div>
            <div className="flex items-center gap-4 mt-2 text-xs">
              <span className="flex items-center gap-1">
                <div className="w-3 h-3 bg-emerald-500 rounded" /> Recebido ({saldo.percentualRecebido.toFixed(1)}%)
              </span>
              <span className="flex items-center gap-1">
                <div className="w-3 h-3 bg-cyan-500 rounded" /> A Receber ({(saldo.percentualMedido - saldo.percentualRecebido).toFixed(1)}%)
              </span>
              <span className="flex items-center gap-1">
                <div className="w-3 h-3 bg-slate-600 rounded" /> A Medir ({(100 - saldo.percentualMedido).toFixed(1)}%)
              </span>
            </div>
          </div>
        </motion.div>

        {/* KPIs */}
        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3">
          <KPICard
            icon={ArrowUpRight}
            label="Receitas Pagas"
            value={`R$ ${formatMoney(totalReceitasRealizadas)}`}
            subvalue="Medições recebidas"
            color="emerald"
            highlight={true}
          />
          <KPICard
            icon={ArrowDownRight}
            label="Despesas Pagas"
            value={`R$ ${formatMoney(totalPago)}`}
            subvalue="Notas baixadas"
            color="red"
            highlight={true}
          />
          <KPICard
            icon={Target}
            label="Resultado DRE"
            value={`R$ ${formatMoney(dreObra.resultado.lucroBruto)}`}
            subvalue={`Margem: ${dreObra.resultado.margemBruta.toFixed(1)}%`}
            color={dreObra.resultado.lucroBruto >= 0 ? 'cyan' : 'amber'}
            highlight={true}
          />
          <KPICard
            icon={Wallet}
            label="Saldo Contrato"
            value={`R$ ${formatMoney(saldoContrato.saldoRestante)}`}
            subvalue={`${saldoContrato.percentualRestante.toFixed(1)}% restante`}
            color="purple"
          />
          <KPICard
            icon={Clock}
            label="Pedidos Futuros"
            value={`R$ ${formatMoney(resumoFuturos.totalFuturo)}`}
            subvalue={`${resumoFuturos.quantidadePedidos} pedidos`}
            color="amber"
          />
          <KPICard
            icon={Receipt}
            label="Receitas/Medições"
            value={medicoesReceitas.length}
            subvalue={`${medicoesReceitas.filter(r => r.status === STATUS_MEDICAO.PAGA).length} pagas`}
            color="teal"
          />
          <KPICard
            icon={Weight}
            label="Peso Previsto"
            value={`${(obra.contrato.pesoTotal / 1000).toFixed(0)} ton`}
            subvalue="107.000 kg"
            color="blue"
          />
          <KPICard
            icon={ClipboardList}
            label="Lançamentos"
            value={lancamentos.length}
            subvalue={`${lancamentos.filter(l => l.status === STATUS_LANCAMENTO.PAGO).length} pagos`}
            color="slate"
          />
        </div>

        {/* Tabs */}
        <Tabs.Root value={activeTab} onValueChange={setActiveTab}>
          <Tabs.List className="flex gap-2 bg-slate-800/50 p-1 rounded-xl w-fit mb-4 overflow-x-auto">
            {[
              { value: 'dashboard', label: 'Dashboard', icon: BarChart3 },
              { value: 'dre', label: 'DRE Obra', icon: TrendingUp },
              { value: 'lancamentos', label: 'Lançamentos', icon: Receipt },
              { value: 'futuros', label: 'Futuro vs Real', icon: Target },
              { value: 'estoque', label: 'Pedido x Entrega', icon: Package },
              { value: 'medicoes', label: 'Medições', icon: ClipboardList },
              { value: 'setores', label: 'Por Setor', icon: Layers },
              { value: 'fluxo', label: 'Fluxo de Caixa', icon: Activity }
            ].map(tab => (
              <Tabs.Trigger
                key={tab.value}
                value={tab.value}
                className="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium text-slate-400
                         data-[state=active]:bg-cyan-500/20 data-[state=active]:text-cyan-400 transition-colors whitespace-nowrap"
              >
                <tab.icon className="w-4 h-4" />
                {tab.label}
              </Tabs.Trigger>
            ))}
          </Tabs.List>

          {/* Tab: Dashboard */}
          <Tabs.Content value="dashboard" className="space-y-4">
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
              {/* Despesas por Categoria */}
              <div className="bg-gradient-to-br from-slate-800/80 to-slate-900/80 backdrop-blur-xl
                            rounded-xl border border-slate-700/50 p-5">
                <h3 className="text-lg font-semibold text-white flex items-center gap-2 mb-4">
                  <PieChartIcon className="w-5 h-5 text-purple-400" />
                  Despesas por Categoria
                </h3>
                <ResponsiveContainer width="100%" height={250}>
                  <PieChart>
                    <Pie
                      data={dadosCategoria}
                      cx="50%"
                      cy="50%"
                      innerRadius={60}
                      outerRadius={100}
                      paddingAngle={2}
                      dataKey="value"
                    >
                      {dadosCategoria.map((entry, index) => (
                        <Cell key={index} fill={entry.color} />
                      ))}
                    </Pie>
                    <Tooltip
                      contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }}
                      formatter={(value) => `R$ ${formatMoney(value)}`}
                    />
                  </PieChart>
                </ResponsiveContainer>
                <div className="grid grid-cols-2 gap-2 mt-4">
                  {dadosCategoria.slice(0, 6).map((item, idx) => (
                    <div key={idx} className="flex items-center gap-2">
                      <div className="w-3 h-3 rounded-full" style={{ backgroundColor: item.color }} />
                      <span className="text-xs text-slate-400 truncate">{item.name}</span>
                      <span className="text-xs text-white font-medium ml-auto">
                        {saldo.totalDespesas > 0 ? ((item.value / saldo.totalDespesas) * 100).toFixed(0) : 0}%
                      </span>
                    </div>
                  ))}
                </div>
              </div>

              {/* Medições por Setor */}
              <div className="bg-gradient-to-br from-slate-800/80 to-slate-900/80 backdrop-blur-xl
                            rounded-xl border border-slate-700/50 p-5">
                <h3 className="text-lg font-semibold text-white flex items-center gap-2 mb-4">
                  <Layers className="w-5 h-5 text-cyan-400" />
                  Medições por Setor
                </h3>
                <ResponsiveContainer width="100%" height={250}>
                  <BarChart data={dadosMedicoes} layout="vertical">
                    <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                    <XAxis type="number" stroke="#64748b" fontSize={12} />
                    <YAxis type="category" dataKey="setor" stroke="#64748b" fontSize={12} width={100} />
                    <Tooltip
                      contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }}
                      formatter={(value) => `${(value / 1000).toFixed(1)} ton`}
                    />
                    <Bar dataKey="fabricacao" name="Fabricação" fill="#8b5cf6" stackId="a" />
                    <Bar dataKey="montagem" name="Montagem" fill="#10b981" stackId="a" />
                    <Bar dataKey="restante" name="Restante" fill="#475569" stackId="a" />
                  </BarChart>
                </ResponsiveContainer>
                <div className="flex items-center gap-4 mt-4 justify-center text-xs">
                  <span className="flex items-center gap-1">
                    <div className="w-3 h-3 bg-purple-500 rounded" /> Fabricação
                  </span>
                  <span className="flex items-center gap-1">
                    <div className="w-3 h-3 bg-emerald-500 rounded" /> Montagem
                  </span>
                  <span className="flex items-center gap-1">
                    <div className="w-3 h-3 bg-slate-600 rounded" /> Restante
                  </span>
                </div>
              </div>
            </div>

            {/* Fluxo de Caixa Preview */}
            <div className="bg-gradient-to-br from-slate-800/80 to-slate-900/80 backdrop-blur-xl
                          rounded-xl border border-slate-700/50 p-5">
              <h3 className="text-lg font-semibold text-white flex items-center gap-2 mb-4">
                <Activity className="w-5 h-5 text-amber-400" />
                Fluxo de Caixa Projetado
              </h3>
              <ResponsiveContainer width="100%" height={200}>
                <ComposedChart data={fluxoCaixa}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                  <XAxis dataKey="mesLabel" stroke="#64748b" fontSize={12} />
                  <YAxis stroke="#64748b" fontSize={12} tickFormatter={(v) => `R$ ${formatMoneyShort(v)}`} />
                  <Tooltip
                    contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }}
                    formatter={(value) => `R$ ${formatMoney(value)}`}
                  />
                  <Bar dataKey="receitas" name="Receitas" fill="#10b981" />
                  <Bar dataKey="despesas" name="Despesas" fill="#ef4444" />
                  <Line type="monotone" dataKey="saldo" name="Saldo" stroke="#06b6d4" strokeWidth={2} />
                </ComposedChart>
              </ResponsiveContainer>
            </div>
          </Tabs.Content>

          {/* Tab: DRE Obra - Demonstrativo de Resultado */}
          <Tabs.Content value="dre" className="space-y-4">
            {/* Header DRE */}
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="bg-gradient-to-r from-emerald-900/40 via-teal-900/30 to-cyan-900/40 backdrop-blur-xl
                       rounded-2xl border border-emerald-500/30 p-6"
            >
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-xl font-bold text-white flex items-center gap-3">
                  <div className="p-2 bg-emerald-500/20 rounded-lg">
                    <TrendingUp className="w-6 h-6 text-emerald-400" />
                  </div>
                  DRE - Demonstrativo de Resultado da Obra
                </h3>
                <div className="text-right">
                  <p className="text-xs text-slate-400">Obra: {obra.nome}</p>
                  <p className="text-sm text-cyan-400 font-medium">Contrato: R$ {(obra.contrato.valorTotal / 1000000).toFixed(2)}M</p>
                </div>
              </div>

              {/* Resumo Principal */}
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                {/* RECEITAS */}
                <div className="bg-emerald-900/30 rounded-xl p-4 border border-emerald-500/30">
                  <p className="text-xs text-emerald-300 flex items-center gap-1 mb-2">
                    <ArrowUpRight className="w-3 h-3" /> RECEITAS REALIZADAS
                  </p>
                  <p className="text-2xl font-bold text-emerald-400">
                    R$ {(totalReceitasRealizadas / 1000).toFixed(0)}k
                  </p>
                  <p className="text-xs text-emerald-500 mt-1">
                    {saldoContrato.percentualMedido.toFixed(1)}% do contrato
                  </p>
                </div>

                {/* CUSTOS */}
                <div className="bg-red-900/30 rounded-xl p-4 border border-red-500/30">
                  <p className="text-xs text-red-300 flex items-center gap-1 mb-2">
                    <ArrowDownRight className="w-3 h-3" /> CUSTOS REALIZADOS
                  </p>
                  <p className="text-2xl font-bold text-red-400">
                    R$ {(dreObra.custos.realizados / 1000).toFixed(0)}k
                  </p>
                  <p className="text-xs text-red-500 mt-1">
                    {((dreObra.custos.realizados / obra.contrato.valorTotal) * 100).toFixed(1)}% do contrato
                  </p>
                </div>

                {/* RESULTADO */}
                <div className={`rounded-xl p-4 border ${
                  dreObra.resultado.lucroBruto >= 0
                    ? 'bg-cyan-900/30 border-cyan-500/30'
                    : 'bg-amber-900/30 border-amber-500/30'
                }`}>
                  <p className={`text-xs flex items-center gap-1 mb-2 ${
                    dreObra.resultado.lucroBruto >= 0 ? 'text-cyan-300' : 'text-amber-300'
                  }`}>
                    <Target className="w-3 h-3" /> RESULTADO ATUAL
                  </p>
                  <p className={`text-2xl font-bold ${
                    dreObra.resultado.lucroBruto >= 0 ? 'text-cyan-400' : 'text-amber-400'
                  }`}>
                    R$ {(dreObra.resultado.lucroBruto / 1000).toFixed(0)}k
                  </p>
                  <p className={`text-xs mt-1 ${
                    dreObra.resultado.lucroBruto >= 0 ? 'text-cyan-500' : 'text-amber-500'
                  }`}>
                    Margem: {dreObra.resultado.margemBruta.toFixed(1)}%
                  </p>
                </div>

                {/* SALDO CONTRATO */}
                <div className="bg-purple-900/30 rounded-xl p-4 border border-purple-500/30">
                  <p className="text-xs text-purple-300 flex items-center gap-1 mb-2">
                    <Wallet className="w-3 h-3" /> SALDO DO CONTRATO
                  </p>
                  <p className="text-2xl font-bold text-purple-400">
                    R$ {(saldoContrato.saldoRestante / 1000000).toFixed(2)}M
                  </p>
                  <p className="text-xs text-purple-500 mt-1">
                    {saldoContrato.percentualRestante.toFixed(1)}% restante
                  </p>
                </div>
              </div>
            </motion.div>

            {/* Receitas Detalhadas */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
              {/* Lista de Receitas (Medições Pagas) */}
              <div className="bg-gradient-to-br from-slate-800/80 to-slate-900/80 backdrop-blur-xl
                            rounded-xl border border-slate-700/50 p-5">
                <h4 className="text-lg font-semibold text-white flex items-center gap-2 mb-4">
                  <ArrowUpRight className="w-5 h-5 text-emerald-400" />
                  Receitas Realizadas (Medições Pagas)
                </h4>

                <div className="space-y-3">
                  {medicoesReceitas.map((receita, idx) => (
                    <motion.div
                      key={receita.id}
                      initial={{ opacity: 0, x: -20 }}
                      animate={{ opacity: 1, x: 0 }}
                      transition={{ delay: idx * 0.05 }}
                      className="p-4 rounded-xl bg-emerald-900/20 border border-emerald-500/30"
                    >
                      <div className="flex items-start justify-between">
                        <div>
                          <div className="flex items-center gap-2">
                            <span className="text-emerald-400 font-medium">#{receita.numero}</span>
                            <span className="px-2 py-0.5 text-xs rounded-full bg-emerald-500/20 text-emerald-400">
                              {receita.tipoReceita === TIPO_RECEITA.ENTRADA ? 'Entrada' : 'Chaparia'}
                            </span>
                          </div>
                          <p className="text-sm text-white mt-1">{receita.descricao}</p>
                          <p className="text-xs text-slate-400 mt-1">
                            NF: {receita.notaFiscal} • {new Date(receita.dataPagamento).toLocaleDateString('pt-BR')}
                          </p>
                        </div>
                        <div className="text-right">
                          <p className="text-lg font-bold text-emerald-400">
                            R$ {(receita.valorBruto || 0).toLocaleString('pt-BR')}
                          </p>
                          <p className="text-xs text-slate-400">
                            Líquido: R$ {(receita.valorLiquido || 0).toLocaleString('pt-BR')}
                          </p>
                        </div>
                      </div>

                      {/* Retenções */}
                      <div className="mt-3 pt-3 border-t border-emerald-500/20 flex gap-4 text-xs">
                        <span className="text-slate-400">ISS: R$ {((receita.retencoes?.iss) || 0).toLocaleString('pt-BR')}</span>
                        <span className="text-slate-400">INSS: R$ {((receita.retencoes?.inss) || 0).toLocaleString('pt-BR')}</span>
                        <span className="text-slate-400">Retenção: R$ {((receita.retencoes?.contratual) || 0).toLocaleString('pt-BR')}</span>
                      </div>
                    </motion.div>
                  ))}
                </div>

                {/* Total */}
                <div className="mt-4 pt-4 border-t border-slate-700/50 flex justify-between">
                  <span className="text-slate-300 font-medium">Total Receitas:</span>
                  <span className="text-emerald-400 font-bold text-lg">
                    R$ {(totalReceitasRealizadas || 0).toLocaleString('pt-BR')}
                  </span>
                </div>
              </div>

              {/* Composição do Contrato */}
              <div className="bg-gradient-to-br from-slate-800/80 to-slate-900/80 backdrop-blur-xl
                            rounded-xl border border-slate-700/50 p-5">
                <h4 className="text-lg font-semibold text-white flex items-center gap-2 mb-4">
                  <Layers className="w-5 h-5 text-purple-400" />
                  Composição do Contrato
                </h4>

                <div className="space-y-3">
                  {composicaoContrato.categorias.map((cat, idx) => {
                    const percentPago = cat.valorPrevisto > 0 ? (cat.valorPago / cat.valorPrevisto) * 100 : 0;
                    return (
                      <div key={cat.id} className="p-3 rounded-lg bg-slate-800/50">
                        <div className="flex items-center justify-between mb-2">
                          <div className="flex items-center gap-2">
                            <span className={`w-3 h-3 rounded-full ${
                              cat.tipo === 'receita' ? 'bg-emerald-500' :
                              cat.tipo === 'despesa' ? 'bg-red-500' : 'bg-amber-500'
                            }`} />
                            <span className="text-white text-sm">{cat.nome}</span>
                          </div>
                          <span className="text-xs text-slate-400">{cat.percentual}%</span>
                        </div>

                        <div className="h-2 bg-slate-700 rounded-full overflow-hidden mb-2">
                          <motion.div
                            initial={{ width: 0 }}
                            animate={{ width: `${percentPago}%` }}
                            className={`h-full rounded-full ${
                              cat.tipo === 'receita' ? 'bg-emerald-500' :
                              cat.tipo === 'despesa' ? 'bg-red-500' : 'bg-amber-500'
                            }`}
                          />
                        </div>

                        <div className="flex justify-between text-xs">
                          <span className="text-slate-400">
                            Pago: R$ {(cat.valorPago / 1000).toFixed(0)}k
                          </span>
                          <span className="text-slate-400">
                            Saldo: R$ {(cat.saldoRestante / 1000).toFixed(0)}k
                          </span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>

            {/* Nota Explicativa DRE */}
            <div className="bg-emerald-900/20 rounded-xl p-4 border border-emerald-500/30">
              <div className="flex items-start gap-3">
                <Info className="w-5 h-5 text-emerald-400 mt-0.5" />
                <div>
                  <h4 className="text-emerald-300 font-medium mb-1">Como funciona o DRE da Obra?</h4>
                  <p className="text-sm text-slate-400">
                    <strong className="text-emerald-400">Receitas:</strong> São as medições aprovadas e pagas pelo cliente. Cada medição abate automaticamente do saldo do contrato.
                  </p>
                  <p className="text-sm text-slate-400 mt-1">
                    <strong className="text-red-400">Custos:</strong> São todas as despesas pagas (material, mão de obra, transporte, etc).
                  </p>
                  <p className="text-sm text-slate-400 mt-1">
                    <strong className="text-cyan-400">Resultado:</strong> Diferença entre Receitas Líquidas e Custos Realizados. Mostra a saúde financeira atual da obra.
                  </p>
                </div>
              </div>
            </div>
          </Tabs.Content>

          {/* Tab: Lançamentos */}
          <Tabs.Content value="lancamentos" className="space-y-4">
            <div className="bg-gradient-to-br from-slate-800/80 to-slate-900/80 backdrop-blur-xl
                          rounded-xl border border-slate-700/50 p-5">
              {/* Header e Filtros */}
              <div className="flex flex-wrap items-center justify-between gap-4 mb-4">
                <h3 className="text-lg font-semibold text-white">Lançamentos de Despesas</h3>

                <div className="flex items-center gap-3">
                  <div className="relative">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                    <input
                      type="text"
                      placeholder="Buscar..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="pl-9 pr-4 py-2 bg-slate-800/50 border border-slate-700/50 rounded-lg
                               text-white text-sm focus:outline-none focus:ring-2 focus:ring-cyan-500/50 w-48"
                    />
                  </div>

                  <Select.Root value={filtroCategoria} onValueChange={setFiltroCategoria}>
                    <Select.Trigger className="flex items-center gap-2 px-3 py-2 bg-slate-800/50
                                             border border-slate-700/50 rounded-lg text-white text-sm">
                      <Filter className="w-4 h-4 text-slate-400" />
                      <Select.Value placeholder="Categoria" />
                    </Select.Trigger>
                    <Select.Portal>
                      <Select.Content className="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden z-50 max-h-60">
                        <Select.Viewport>
                          <Select.Item value="todas" className="px-4 py-2 text-white hover:bg-slate-700 cursor-pointer text-sm">
                            <Select.ItemText>Todas Categorias</Select.ItemText>
                          </Select.Item>
                          {Object.entries(CATEGORIA_LABELS).map(([key, label]) => (
                            <Select.Item key={key} value={key} className="px-4 py-2 text-white hover:bg-slate-700 cursor-pointer text-sm">
                              <Select.ItemText>{label}</Select.ItemText>
                            </Select.Item>
                          ))}
                        </Select.Viewport>
                      </Select.Content>
                    </Select.Portal>
                  </Select.Root>

                  <Select.Root value={filtroStatus} onValueChange={setFiltroStatus}>
                    <Select.Trigger className="flex items-center gap-2 px-3 py-2 bg-slate-800/50
                                             border border-slate-700/50 rounded-lg text-white text-sm">
                      <Select.Value placeholder="Status" />
                    </Select.Trigger>
                    <Select.Portal>
                      <Select.Content className="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden z-50">
                        <Select.Viewport>
                          <Select.Item value="todos" className="px-4 py-2 text-white hover:bg-slate-700 cursor-pointer text-sm">
                            <Select.ItemText>Todos Status</Select.ItemText>
                          </Select.Item>
                          {Object.entries(STATUS_LANCAMENTO).map(([key, value]) => (
                            <Select.Item key={key} value={value} className="px-4 py-2 text-white hover:bg-slate-700 cursor-pointer text-sm">
                              <Select.ItemText>{key.charAt(0) + key.slice(1).toLowerCase()}</Select.ItemText>
                            </Select.Item>
                          ))}
                        </Select.Viewport>
                      </Select.Content>
                    </Select.Portal>
                  </Select.Root>

                  <button
                    onClick={() => setShowNovoLancamento(true)}
                    className="flex items-center gap-2 px-4 py-2 bg-emerald-500/20 text-emerald-400
                             rounded-lg hover:bg-emerald-500/30 transition-colors text-sm"
                  >
                    <Plus className="w-4 h-4" />
                    Novo Lançamento
                  </button>
                </div>
              </div>

              {/* Tabela de Lançamentos */}
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="text-xs text-slate-400 border-b border-slate-700/50">
                      <th className="text-left py-3 px-2">Descrição</th>
                      <th className="text-left py-3 px-2">Categoria</th>
                      <th className="text-left py-3 px-2">Fornecedor</th>
                      <th className="text-center py-3 px-2">Vencimento</th>
                      <th className="text-right py-3 px-2">Valor</th>
                      <th className="text-center py-3 px-2">Status</th>
                      <th className="text-center py-3 px-2">Ações</th>
                    </tr>
                  </thead>
                  <tbody>
                    {lancamentosFiltrados.slice(0, 15).map((lanc, idx) => {
                      const statusStyle = STATUS_COLORS[lanc.status] || STATUS_COLORS[STATUS_LANCAMENTO.PENDENTE];
                      return (
                        <motion.tr
                          key={lanc.id}
                          initial={{ opacity: 0 }}
                          animate={{ opacity: 1 }}
                          transition={{ delay: idx * 0.02 }}
                          className="border-b border-slate-700/30 hover:bg-slate-700/20"
                        >
                          <td className="py-3 px-2">
                            <div>
                              <p className="text-white text-sm">{lanc.descricao}</p>
                              {lanc.notaFiscal && (
                                <p className="text-xs text-slate-500">{lanc.notaFiscal}</p>
                              )}
                            </div>
                          </td>
                          <td className="py-3 px-2 text-slate-400 text-sm">
                            {CATEGORIA_LABELS[lanc.categoria] || lanc.categoria}
                          </td>
                          <td className="py-3 px-2 text-slate-300 text-sm">{lanc.fornecedor}</td>
                          <td className="py-3 px-2 text-center text-slate-400 text-sm">
                            {lanc.dataVencimento ? new Date(lanc.dataVencimento).toLocaleDateString('pt-BR') : '-'}
                          </td>
                          <td className="py-3 px-2 text-right text-white font-medium">
                            R$ {(lanc.valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                          </td>
                          <td className="py-3 px-2 text-center">
                            <span className={`px-2 py-1 text-xs rounded-full ${statusStyle.bg} ${statusStyle.text}`}>
                              {lanc.status.charAt(0).toUpperCase() + lanc.status.slice(1)}
                            </span>
                          </td>
                          <td className="py-3 px-2 text-center">
                            <div className="flex items-center justify-center gap-1">
                              {lanc.status === STATUS_LANCAMENTO.PENDENTE && (
                                <button
                                  onClick={() => atualizarStatusLancamento(lanc.id, STATUS_LANCAMENTO.APROVADO)}
                                  className="p-1.5 text-blue-400 hover:bg-blue-500/20 rounded transition-colors"
                                  title="Aprovar"
                                >
                                  <Check className="w-4 h-4" />
                                </button>
                              )}
                              {lanc.status === STATUS_LANCAMENTO.APROVADO && (
                                <button
                                  onClick={() => atualizarStatusLancamento(lanc.id, STATUS_LANCAMENTO.PAGO)}
                                  className="p-1.5 text-emerald-400 hover:bg-emerald-500/20 rounded transition-colors"
                                  title="Marcar como Pago"
                                >
                                  <DollarSign className="w-4 h-4" />
                                </button>
                              )}
                              <button className="p-1.5 text-slate-400 hover:bg-slate-500/20 rounded transition-colors">
                                <Eye className="w-4 h-4" />
                              </button>
                            </div>
                          </td>
                        </motion.tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>

              {/* Totais */}
              <div className="mt-4 pt-4 border-t border-slate-700/50 flex items-center justify-between">
                <p className="text-sm text-slate-400">
                  {lancamentosFiltrados.length} lançamentos encontrados
                </p>
                <div className="flex items-center gap-6">
                  <div>
                    <p className="text-xs text-slate-500">Total Filtrado</p>
                    <p className="text-lg font-bold text-white">
                      R$ {lancamentosFiltrados.reduce((s, l) => s + l.valor, 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                    </p>
                  </div>
                  <div>
                    <p className="text-xs text-slate-500">Pago</p>
                    <p className="text-lg font-bold text-emerald-400">
                      R$ {lancamentosFiltrados.filter(l => l.status === STATUS_LANCAMENTO.PAGO).reduce((s, l) => s + l.valor, 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                    </p>
                  </div>
                  <div>
                    <p className="text-xs text-slate-500">A Pagar</p>
                    <p className="text-lg font-bold text-amber-400">
                      R$ {lancamentosFiltrados.filter(l => l.status !== STATUS_LANCAMENTO.PAGO && l.status !== STATUS_LANCAMENTO.CANCELADO).reduce((s, l) => s + l.valor, 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </Tabs.Content>

          {/* Tab: Futuro vs Real */}
          <Tabs.Content value="futuros" className="space-y-4">
            {/* Header da Análise */}
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="bg-gradient-to-r from-amber-900/40 via-orange-900/30 to-red-900/40 backdrop-blur-xl
                       rounded-2xl border border-amber-500/30 p-6"
            >
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-xl font-bold text-white flex items-center gap-3">
                  <div className="p-2 bg-amber-500/20 rounded-lg">
                    <Target className="w-6 h-6 text-amber-400" />
                  </div>
                  Análise Financeira: REAL vs FUTURO
                </h3>
                <div className="flex items-center gap-2">
                  <span className={`px-3 py-1 rounded-full text-sm font-medium ${
                    analiseProjecao.analiseRisco.status === 'saudavel' ? 'bg-emerald-500/20 text-emerald-400' :
                    analiseProjecao.analiseRisco.status === 'atencao' ? 'bg-amber-500/20 text-amber-400' :
                    'bg-red-500/20 text-red-400'
                  }`}>
                    {analiseProjecao.analiseRisco.status === 'saudavel' ? '✓ Saudável' :
                     analiseProjecao.analiseRisco.status === 'atencao' ? '⚠ Atenção' : '⛔ Crítico'}
                  </span>
                </div>
              </div>

              {/* Cards de Comparação */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {/* REAL */}
                <div className="bg-emerald-900/30 rounded-xl p-4 border border-emerald-500/30">
                  <div className="flex items-center gap-2 mb-3">
                    <CheckCircle2 className="w-5 h-5 text-emerald-400" />
                    <h4 className="text-emerald-300 font-medium">DESPESAS REAIS</h4>
                  </div>
                  <p className="text-3xl font-bold text-emerald-400">
                    R$ {formatMoney(analiseProjecao.real.totalDespesas)}
                  </p>
                  <p className="text-sm text-emerald-500 mt-1">
                    {analiseProjecao.real.valorContrato > 0 ? ((analiseProjecao.real.totalDespesas / analiseProjecao.real.valorContrato) * 100).toFixed(1) : 0}% do contrato
                  </p>
                  <div className="mt-3 pt-3 border-t border-emerald-500/30 text-sm">
                    <div className="flex justify-between text-slate-300">
                      <span>Saldo a Medir:</span>
                      <span className="font-medium">R$ {formatMoney(analiseProjecao.real.saldoAMedir)}</span>
                    </div>
                  </div>
                </div>

                {/* FUTURO (Pré-Aprovados) */}
                <div className="bg-amber-900/30 rounded-xl p-4 border border-amber-500/30">
                  <div className="flex items-center gap-2 mb-3">
                    <Clock className="w-5 h-5 text-amber-400" />
                    <h4 className="text-amber-300 font-medium">PEDIDOS PRÉ-APROVADOS</h4>
                  </div>
                  <p className="text-3xl font-bold text-amber-400">
                    R$ {formatMoney(analiseProjecao.futuro.totalValor)}
                  </p>
                  <p className="text-sm text-amber-500 mt-1">
                    {analiseProjecao.futuro.impactoPercentual.toFixed(1)}% do contrato
                  </p>
                  <div className="mt-3 pt-3 border-t border-amber-500/30 text-sm">
                    <div className="flex justify-between text-slate-300">
                      <span>Pedidos:</span>
                      <span className="font-medium">{analiseProjecao.futuro.totalPedidos} pendentes</span>
                    </div>
                  </div>
                </div>

                {/* PROJEÇÃO */}
                <div className={`rounded-xl p-4 border ${
                  analiseProjecao.projecao.alertaSaldo
                    ? 'bg-red-900/30 border-red-500/30'
                    : 'bg-cyan-900/30 border-cyan-500/30'
                }`}>
                  <div className="flex items-center gap-2 mb-3">
                    <TrendingUp className={`w-5 h-5 ${analiseProjecao.projecao.alertaSaldo ? 'text-red-400' : 'text-cyan-400'}`} />
                    <h4 className={`font-medium ${analiseProjecao.projecao.alertaSaldo ? 'text-red-300' : 'text-cyan-300'}`}>
                      PROJEÇÃO TOTAL
                    </h4>
                  </div>
                  <p className={`text-3xl font-bold ${analiseProjecao.projecao.alertaSaldo ? 'text-red-400' : 'text-cyan-400'}`}>
                    R$ {formatMoney(analiseProjecao.projecao.totalDespesas)}
                  </p>
                  <p className={`text-sm mt-1 ${analiseProjecao.projecao.alertaSaldo ? 'text-red-500' : 'text-cyan-500'}`}>
                    {analiseProjecao.analiseRisco.percentualComprometido.toFixed(1)}% comprometido
                  </p>
                  <div className={`mt-3 pt-3 border-t text-sm ${analiseProjecao.projecao.alertaSaldo ? 'border-red-500/30' : 'border-cyan-500/30'}`}>
                    <div className="flex justify-between text-slate-300">
                      <span>Saldo Projetado:</span>
                      <span className={`font-medium ${analiseProjecao.projecao.saldoDisponivel < 0 ? 'text-red-400' : 'text-white'}`}>
                        R$ {formatMoney(analiseProjecao.projecao.saldoDisponivel)}
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              {/* Barra de Progresso Visual */}
              <div className="mt-6">
                <div className="flex items-center justify-between text-xs text-slate-400 mb-2">
                  <span>Composição do Contrato (R$ {(obra.contrato.valorTotal / 1000000).toFixed(2)}M)</span>
                  <span>Margem: {analiseProjecao.projecao.margemProjetada.toFixed(1)}%</span>
                </div>
                <div className="h-8 bg-slate-700 rounded-full overflow-hidden flex">
                  <motion.div
                    initial={{ width: 0 }}
                    animate={{ width: `${obra.contrato.valorTotal > 0 ? (analiseProjecao.real.totalDespesas / obra.contrato.valorTotal) * 100 : 0}%` }}
                    className="bg-emerald-500 h-full flex items-center justify-center"
                    title="Despesas Reais"
                  >
                    <span className="text-xs font-medium text-white px-1">Real</span>
                  </motion.div>
                  <motion.div
                    initial={{ width: 0 }}
                    animate={{ width: `${analiseProjecao.futuro.impactoPercentual}%` }}
                    className="bg-amber-500 h-full flex items-center justify-center"
                    title="Pedidos Futuros"
                  >
                    <span className="text-xs font-medium text-white px-1">Futuro</span>
                  </motion.div>
                  <motion.div
                    initial={{ width: 0 }}
                    animate={{ width: `${Math.max(0, analiseProjecao.analiseRisco.margemSeguranca)}%` }}
                    className="bg-slate-600 h-full flex items-center justify-center"
                    title="Saldo Disponível"
                  >
                    <span className="text-xs font-medium text-slate-300 px-1">Saldo</span>
                  </motion.div>
                </div>
                <div className="flex items-center gap-4 mt-2 text-xs justify-center">
                  <span className="flex items-center gap-1">
                    <div className="w-3 h-3 bg-emerald-500 rounded" /> Real ({((analiseProjecao.real.totalDespesas / obra.contrato.valorTotal) * 100).toFixed(1)}%)
                  </span>
                  <span className="flex items-center gap-1">
                    <div className="w-3 h-3 bg-amber-500 rounded" /> Futuro ({analiseProjecao.futuro.impactoPercentual.toFixed(1)}%)
                  </span>
                  <span className="flex items-center gap-1">
                    <div className="w-3 h-3 bg-slate-600 rounded" /> Saldo ({Math.max(0, analiseProjecao.analiseRisco.margemSeguranca).toFixed(1)}%)
                  </span>
                </div>
              </div>
            </motion.div>

            {/* Lista de Pedidos Pré-Aprovados */}
            <div className="bg-gradient-to-br from-slate-800/80 to-slate-900/80 backdrop-blur-xl
                          rounded-xl border border-slate-700/50 p-5">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                  <FileText className="w-5 h-5 text-amber-400" />
                  Pedidos Pré-Aprovados (Despesas Futuras)
                </h3>
                <div className="flex items-center gap-2">
                  <span className="text-xs px-2 py-1 bg-amber-500/20 text-amber-400 rounded-full">
                    {resumoFuturos.quantidadePedidos} pedidos
                  </span>
                  <span className="text-xs px-2 py-1 bg-red-500/20 text-red-400 rounded-full">
                    R$ {formatMoney(resumoFuturos.totalFuturo)} pendente
                  </span>
                </div>
              </div>

              {/* Tabela de Pedidos */}
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="text-xs text-slate-400 border-b border-slate-700/50">
                      <th className="text-left py-3 px-2">Pedido</th>
                      <th className="text-left py-3 px-2">Fornecedor</th>
                      <th className="text-left py-3 px-2">Descrição</th>
                      <th className="text-center py-3 px-2">Previsão</th>
                      <th className="text-right py-3 px-2">Valor</th>
                      <th className="text-center py-3 px-2">Status</th>
                      <th className="text-center py-3 px-2">Setor</th>
                    </tr>
                  </thead>
                  <tbody>
                    {pedidosFuturos.map((pedido, idx) => {
                      const statusColors = {
                        [STATUS_PEDIDO_FUTURO.AGUARDANDO_ENTREGA]: { bg: 'bg-slate-500/20', text: 'text-slate-400', label: 'Aguardando' },
                        [STATUS_PEDIDO_FUTURO.EM_PRODUCAO]: { bg: 'bg-blue-500/20', text: 'text-blue-400', label: 'Em Produção' },
                        [STATUS_PEDIDO_FUTURO.PARCIAL_ENTREGUE]: { bg: 'bg-amber-500/20', text: 'text-amber-400', label: 'Parcial' },
                        [STATUS_PEDIDO_FUTURO.ENTREGUE]: { bg: 'bg-emerald-500/20', text: 'text-emerald-400', label: 'Entregue' },
                        [STATUS_PEDIDO_FUTURO.CANCELADO]: { bg: 'bg-red-500/20', text: 'text-red-400', label: 'Cancelado' }
                      };
                      const statusStyle = statusColors[pedido.status] || statusColors[STATUS_PEDIDO_FUTURO.AGUARDANDO_ENTREGA];

                      return (
                        <motion.tr
                          key={pedido.id}
                          initial={{ opacity: 0 }}
                          animate={{ opacity: 1 }}
                          transition={{ delay: idx * 0.03 }}
                          className="border-b border-slate-700/30 hover:bg-slate-700/20"
                        >
                          <td className="py-3 px-2">
                            <div>
                              <p className="text-cyan-400 font-medium text-sm">{pedido.numeroPedido}</p>
                              <p className="text-xs text-slate-500">{new Date(pedido.dataPedido).toLocaleDateString('pt-BR')}</p>
                            </div>
                          </td>
                          <td className="py-3 px-2 text-white text-sm">{pedido.fornecedor}</td>
                          <td className="py-3 px-2">
                            <p className="text-slate-300 text-sm">{pedido.descricao}</p>
                            {pedido.pesoKg && (
                              <p className="text-xs text-slate-500">{(pedido.pesoKg / 1000).toFixed(2)} ton</p>
                            )}
                          </td>
                          <td className="py-3 px-2 text-center text-slate-400 text-sm">
                            {new Date(pedido.dataPrevisaoEntrega).toLocaleDateString('pt-BR')}
                          </td>
                          <td className="py-3 px-2 text-right">
                            <p className="text-amber-400 font-bold">
                              R$ {(pedido.valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                            </p>
                            {pedido.precoKg && (
                              <p className="text-xs text-slate-500">R$ {((pedido.precoKg || 0).toFixed(2))}/kg</p>
                            )}
                          </td>
                          <td className="py-3 px-2 text-center">
                            <span className={`px-2 py-1 text-xs rounded-full ${statusStyle.bg} ${statusStyle.text}`}>
                              {statusStyle.label}
                            </span>
                          </td>
                          <td className="py-3 px-2 text-center">
                            <span className="px-2 py-1 text-xs rounded-full bg-cyan-500/20 text-cyan-400">
                              {pedido.setor}
                            </span>
                          </td>
                        </motion.tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>

              {/* Rodapé com Totais */}
              <div className="mt-4 pt-4 border-t border-slate-700/50 grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="bg-slate-800/50 rounded-lg p-3 text-center">
                  <p className="text-xs text-slate-400">Material</p>
                  <p className="text-lg font-bold text-white">R$ {formatMoney(resumoFuturos.totalMaterial)}</p>
                </div>
                <div className="bg-slate-800/50 rounded-lg p-3 text-center">
                  <p className="text-xs text-slate-400">Serviços</p>
                  <p className="text-lg font-bold text-white">R$ {formatMoney(resumoFuturos.totalServico)}</p>
                </div>
                <div className="bg-amber-900/30 rounded-lg p-3 text-center border border-amber-500/30">
                  <p className="text-xs text-amber-300">Total Futuro</p>
                  <p className="text-lg font-bold text-amber-400">R$ {formatMoney(resumoFuturos.totalFuturo)}</p>
                </div>
                <div className={`rounded-lg p-3 text-center border ${analiseProjecao.projecao.alertaSaldo ? 'bg-red-900/30 border-red-500/30' : 'bg-emerald-900/30 border-emerald-500/30'}`}>
                  <p className={`text-xs ${analiseProjecao.projecao.alertaSaldo ? 'text-red-300' : 'text-emerald-300'}`}>Saldo Projetado</p>
                  <p className={`text-lg font-bold ${analiseProjecao.projecao.alertaSaldo ? 'text-red-400' : 'text-emerald-400'}`}>
                    R$ {formatMoney(analiseProjecao.projecao.saldoDisponivel)}
                  </p>
                </div>
              </div>
            </div>

            {/* Nota Explicativa */}
            <div className="bg-blue-900/20 rounded-xl p-4 border border-blue-500/30">
              <div className="flex items-start gap-3">
                <Info className="w-5 h-5 text-blue-400 mt-0.5" />
                <div>
                  <h4 className="text-blue-300 font-medium mb-1">Como funciona a análise Futuro vs Real?</h4>
                  <p className="text-sm text-slate-400">
                    <strong className="text-emerald-400">Despesas Reais:</strong> São lançamentos já efetivados com entrada de nota fiscal e impactam o saldo da obra automaticamente.
                  </p>
                  <p className="text-sm text-slate-400 mt-1">
                    <strong className="text-amber-400">Pedidos Pré-Aprovados:</strong> São compromissos futuros que <u>NÃO impactam</u> o saldo real da obra. Servem apenas para projeção e planejamento.
                  </p>
                  <p className="text-sm text-slate-400 mt-1">
                    <strong className="text-cyan-400">Projeção:</strong> Soma de Real + Futuro para análise de viabilidade e risco financeiro.
                  </p>
                </div>
              </div>
            </div>
          </Tabs.Content>

          {/* Tab: Pedido x Entrega (Estoque) */}
          <Tabs.Content value="estoque" className="space-y-4">
            {/* KPIs de Material */}
            <div className="grid grid-cols-2 lg:grid-cols-5 gap-4">
              <KPICard
                icon={Package}
                label="Valor Total Pedido"
                value={`R$ ${((resumoMateriais.valorTotalPedido || 0) / 1000).toFixed(0)}k`}
                subvalue={`${(resumoMateriais.pesoTotalPedido || 0).toLocaleString('pt-BR')} kg`}
                color="cyan"
              />
              <KPICard
                icon={Truck}
                label="Valor Entregue"
                value={`R$ ${((resumoMateriais.valorTotalEntregue || 0) / 1000).toFixed(0)}k`}
                subvalue={`${(resumoMateriais.pesoTotalEntregue || 0).toLocaleString('pt-BR')} kg`}
                color="emerald"
              />
              <KPICard
                icon={(resumoMateriais.valorFaltaEntregar || 0) < 0 ? CheckCircle2 : AlertTriangle}
                label={(resumoMateriais.valorFaltaEntregar || 0) < 0 ? "Excesso Entregue" : "Falta Entregar"}
                value={`R$ ${(Math.abs(resumoMateriais.valorFaltaEntregar || 0) / 1000).toFixed(0)}k`}
                subvalue={`${Math.abs(resumoMateriais.pesoFaltaEntregar || 0).toLocaleString('pt-BR')} kg`}
                color={(resumoMateriais.valorFaltaEntregar || 0) < 0 ? "emerald" : "amber"}
                highlight={(resumoMateriais.pesoFaltaEntregar || 0) > 0}
              />
              <KPICard
                icon={Layers}
                label="Estoque Disponível"
                value={`${(resumoMateriais.pesoEmEstoque || 0).toLocaleString('pt-BR')} kg`}
                subvalue="Pronto p/ produção"
                color="purple"
              />
              <KPICard
                icon={CheckCircle2}
                label="Itens Entregues"
                value={`${resumoMateriais.itensEntregues || 0}/${resumoMateriais.totalItens || 0}`}
                subvalue={`${((((resumoMateriais.itensEntregues || 0) / (resumoMateriais.totalItens || 1)) * 100) || 0).toFixed(0)}% completo`}
                color="green"
              />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
              {/* Gráfico Estoque por Tipo */}
              <div className="bg-gradient-to-br from-slate-800/80 to-slate-900/80 backdrop-blur-xl
                            rounded-xl border border-slate-700/50 p-5">
                <h3 className="text-lg font-semibold text-white flex items-center gap-2 mb-4">
                  <PieChartIcon className="w-5 h-5 text-cyan-400" />
                  Estoque por Tipo de Material
                </h3>
                <ResponsiveContainer width="100%" height={250}>
                  <PieChart>
                    <Pie
                      data={estoquePorTipo}
                      cx="50%"
                      cy="50%"
                      innerRadius={50}
                      outerRadius={90}
                      paddingAngle={2}
                      dataKey="pesoTotal"
                      nameKey="tipo"
                    >
                      {estoquePorTipo.map((entry, index) => (
                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                      ))}
                    </Pie>
                    <Tooltip
                      contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }}
                      formatter={(value) => [`${(value || 0).toLocaleString('pt-BR')} kg`, 'Peso']}
                    />
                  </PieChart>
                </ResponsiveContainer>
                <div className="grid grid-cols-2 gap-2 mt-4">
                  {estoquePorTipo.map((item, idx) => (
                    <div key={item.tipo} className="flex items-center gap-2">
                      <div className="w-3 h-3 rounded-full" style={{ backgroundColor: COLORS[idx % COLORS.length] }} />
                      <span className="text-xs text-slate-300 truncate">{item.tipoLabel}</span>
                      <span className="text-xs text-slate-400 ml-auto">{(item.pesoTotal || 0).toLocaleString('pt-BR')}kg</span>
                    </div>
                  ))}
                </div>
              </div>

              {/* Lista de Materiais com Pendência */}
              <div className="lg:col-span-2 bg-gradient-to-br from-slate-800/80 to-slate-900/80 backdrop-blur-xl
                            rounded-xl border border-slate-700/50 p-5">
                <h3 className="text-lg font-semibold text-white flex items-center gap-2 mb-4">
                  <AlertTriangle className="w-5 h-5 text-amber-400" />
                  Materiais com Entrega Pendente
                </h3>
                <div className="space-y-2 max-h-[300px] overflow-y-auto pr-2">
                  {materiais.filter(m => m.pesoFaltaEntregar > 0).length === 0 ? (
                    <div className="text-center py-8 text-slate-400">
                      <CheckCircle2 className="w-12 h-12 mx-auto mb-2 text-emerald-500" />
                      <p>Todos os materiais foram entregues!</p>
                    </div>
                  ) : (
                    materiais.filter(m => m.pesoFaltaEntregar > 0).map((mat, idx) => (
                      <motion.div
                        key={mat.id}
                        initial={{ opacity: 0, x: -20 }}
                        animate={{ opacity: 1, x: 0 }}
                        transition={{ delay: idx * 0.03 }}
                        className="p-3 rounded-lg bg-amber-900/20 border border-amber-500/30"
                      >
                        <div className="flex items-center justify-between">
                          <div className="flex-1">
                            <div className="flex items-center gap-2">
                              <span className="text-amber-400 font-medium text-sm">{mat.codigo}</span>
                              <span className="px-2 py-0.5 text-xs rounded-full bg-amber-500/20 text-amber-300">
                                {mat.tipo.toUpperCase()}
                              </span>
                            </div>
                            <p className="text-xs text-slate-400 mt-1">{mat.descricao}</p>
                          </div>
                          <div className="text-right">
                            <p className="text-amber-400 font-bold">
                              -{(mat.pesoFaltaEntregar || 0).toLocaleString('pt-BR')} kg
                            </p>
                            <p className="text-xs text-slate-400">
                              R$ {(((mat.pesoFaltaEntregar || 0) * (mat.valorUnitario || 0)) || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                            </p>
                          </div>
                        </div>
                        {/* Barra de progresso */}
                        <div className="mt-2">
                          <div className="h-1.5 bg-slate-700 rounded-full overflow-hidden">
                            <motion.div
                              initial={{ width: 0 }}
                              animate={{ width: `${((mat.pesoEntregue || 0) / (mat.pesoPedido || 1)) * 100}%` }}
                              className="h-full bg-amber-500 rounded-full"
                            />
                          </div>
                          <div className="flex justify-between text-[10px] text-slate-500 mt-1">
                            <span>Entregue: {(mat.pesoEntregue || 0).toLocaleString('pt-BR')}kg</span>
                            <span>Pedido: {(mat.pesoPedido || 0).toLocaleString('pt-BR')}kg</span>
                          </div>
                        </div>
                      </motion.div>
                    ))
                  )}
                </div>
              </div>
            </div>

            {/* Tabela Completa de Materiais */}
            <div className="bg-gradient-to-br from-slate-800/80 to-slate-900/80 backdrop-blur-xl
                          rounded-xl border border-slate-700/50 p-5">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                  <ClipboardList className="w-5 h-5 text-cyan-400" />
                  Controle Pedido x Entrega - Todos os Materiais
                </h3>
                <div className="flex items-center gap-2">
                  <span className="px-3 py-1 text-xs rounded-full bg-emerald-500/20 text-emerald-400 border border-emerald-500/30">
                    {materiais.filter(m => m.status === STATUS_MATERIAL.ENTREGUE).length} Entregues
                  </span>
                  <span className="px-3 py-1 text-xs rounded-full bg-amber-500/20 text-amber-400 border border-amber-500/30">
                    {materiais.filter(m => m.status === STATUS_MATERIAL.PARCIAL).length} Parciais
                  </span>
                  <span className="px-3 py-1 text-xs rounded-full bg-slate-500/20 text-slate-400 border border-slate-500/30">
                    {materiais.filter(m => m.status === STATUS_MATERIAL.PEDIDO).length} Pendentes
                  </span>
                </div>
              </div>

              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="text-xs text-slate-400 border-b border-slate-700/50">
                      <th className="text-left py-3 px-3">Código / Descrição</th>
                      <th className="text-left py-3 px-2">Tipo</th>
                      <th className="text-right py-3 px-2">Pedido (kg)</th>
                      <th className="text-right py-3 px-2">Entregue (kg)</th>
                      <th className="text-right py-3 px-2">Falta (kg)</th>
                      <th className="text-right py-3 px-2">R$/kg</th>
                      <th className="text-right py-3 px-2">Valor Pedido</th>
                      <th className="text-right py-3 px-2">Valor Entregue</th>
                      <th className="text-center py-3 px-2">Estoque</th>
                      <th className="text-center py-3 px-2">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {materiais.map((mat, idx) => {
                      const statusColor = mat.status === STATUS_MATERIAL.ENTREGUE
                        ? 'bg-emerald-500/20 text-emerald-400'
                        : mat.status === STATUS_MATERIAL.PARCIAL
                          ? 'bg-amber-500/20 text-amber-400'
                          : 'bg-slate-500/20 text-slate-400';
                      const statusLabel = mat.status === STATUS_MATERIAL.ENTREGUE
                        ? 'Entregue'
                        : mat.status === STATUS_MATERIAL.PARCIAL
                          ? 'Parcial'
                          : 'Pendente';
                      return (
                        <motion.tr
                          key={mat.id}
                          initial={{ opacity: 0 }}
                          animate={{ opacity: 1 }}
                          transition={{ delay: idx * 0.02 }}
                          className="border-b border-slate-700/30 hover:bg-slate-800/30"
                        >
                          <td className="py-3 px-3">
                            <div className="font-medium text-white text-sm">{mat.codigo}</div>
                            <div className="text-xs text-slate-400">{mat.descricao}</div>
                          </td>
                          <td className="py-3 px-2">
                            <span className="px-2 py-0.5 text-[10px] rounded bg-cyan-500/20 text-cyan-300 uppercase">
                              {mat.tipo.replace('_', ' ')}
                            </span>
                          </td>
                          <td className="py-3 px-2 text-right text-slate-300 text-sm">
                            {(mat.pesoPedido || 0).toLocaleString('pt-BR')}
                          </td>
                          <td className="py-3 px-2 text-right text-emerald-400 text-sm">
                            {(mat.pesoEntregue || 0).toLocaleString('pt-BR')}
                          </td>
                          <td className={`py-3 px-2 text-right text-sm font-medium ${(mat.pesoFaltaEntregar || 0) > 0 ? 'text-amber-400' : 'text-slate-500'}`}>
                            {(mat.pesoFaltaEntregar || 0) > 0 ? `-${(mat.pesoFaltaEntregar || 0).toLocaleString('pt-BR')}` : '0'}
                          </td>
                          <td className="py-3 px-2 text-right text-slate-400 text-xs">
                            {((mat.valorUnitario || 0).toFixed(4))}
                          </td>
                          <td className="py-3 px-2 text-right text-slate-300 text-sm">
                            R$ {(mat.valorTotalPedido || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                          </td>
                          <td className="py-3 px-2 text-right text-emerald-400 text-sm">
                            R$ {(((mat.pesoEntregue || 0) * (mat.valorUnitario || 0)) || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                          </td>
                          <td className="py-3 px-2 text-center">
                            <span className={`px-2 py-1 text-xs rounded ${(mat.disponivelEstoque || 0) > 0 ? 'bg-purple-500/20 text-purple-400' : 'bg-slate-600/20 text-slate-500'}`}>
                              {(mat.disponivelEstoque || 0).toLocaleString('pt-BR')} kg
                            </span>
                          </td>
                          <td className="py-3 px-2 text-center">
                            <span className={`px-2 py-1 text-xs rounded ${statusColor}`}>
                              {statusLabel}
                            </span>
                          </td>
                        </motion.tr>
                      );
                    })}
                  </tbody>
                  <tfoot>
                    <tr className="border-t-2 border-slate-600 font-semibold">
                      <td colSpan="2" className="py-3 px-3 text-white">TOTAL ({materiais.length} itens)</td>
                      <td className="py-3 px-2 text-right text-cyan-400">
                        {(resumoMateriais.pesoTotalPedido || 0).toLocaleString('pt-BR')} kg
                      </td>
                      <td className="py-3 px-2 text-right text-emerald-400">
                        {(resumoMateriais.pesoTotalEntregue || 0).toLocaleString('pt-BR')} kg
                      </td>
                      <td className="py-3 px-2 text-right text-amber-400">
                        {(resumoMateriais.pesoFaltaEntregar || 0) > 0 ? `-${(resumoMateriais.pesoFaltaEntregar || 0).toLocaleString('pt-BR')}` : '0'} kg
                      </td>
                      <td className="py-3 px-2 text-right text-slate-400">-</td>
                      <td className="py-3 px-2 text-right text-cyan-400">
                        R$ {(resumoMateriais.valorTotalPedido || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                      </td>
                      <td className="py-3 px-2 text-right text-emerald-400">
                        R$ {(resumoMateriais.valorTotalEntregue || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                      </td>
                      <td className="py-3 px-2 text-center text-purple-400">
                        {(resumoMateriais.pesoEmEstoque || 0).toLocaleString('pt-BR')} kg
                      </td>
                      <td className="py-3 px-2"></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>

            {/* Nota Explicativa */}
            <div className="bg-cyan-900/20 rounded-xl p-4 border border-cyan-500/30">
              <div className="flex items-start gap-3">
                <Info className="w-5 h-5 text-cyan-400 mt-0.5" />
                <div>
                  <h4 className="text-cyan-300 font-medium mb-1">Controle Pedido x Entrega</h4>
                  <p className="text-sm text-slate-400">
                    <strong className="text-cyan-400">Pedido:</strong> Total de material solicitado ao fornecedor com valor e peso previsto.
                  </p>
                  <p className="text-sm text-slate-400 mt-1">
                    <strong className="text-emerald-400">Entregue:</strong> Material já recebido com nota fiscal e disponível no estoque da obra.
                  </p>
                  <p className="text-sm text-slate-400 mt-1">
                    <strong className="text-amber-400">Falta Entregar:</strong> Saldo pendente que o fornecedor ainda deve entregar para completar o pedido.
                  </p>
                  <p className="text-sm text-slate-400 mt-1">
                    <strong className="text-purple-400">Estoque Disponível:</strong> Material em estoque pronto para baixa na produção. Automaticamente vinculado ao módulo de estoque.
                  </p>
                </div>
              </div>
            </div>
          </Tabs.Content>

          {/* Tab: Medições */}
          <Tabs.Content value="medicoes" className="space-y-4">
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
              {/* Lista de Medições */}
              <div className="lg:col-span-2 bg-gradient-to-br from-slate-800/80 to-slate-900/80 backdrop-blur-xl
                            rounded-xl border border-slate-700/50 p-5">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold text-white">Medições Realizadas</h3>
                  <button
                    onClick={() => setShowNovaMedicao(true)}
                    className="flex items-center gap-2 px-4 py-2 bg-purple-500/20 text-purple-400
                             rounded-lg hover:bg-purple-500/30 transition-colors text-sm"
                  >
                    <Plus className="w-4 h-4" />
                    Nova Medição
                  </button>
                </div>

                <div className="space-y-3">
                  {medicoes.map((med, idx) => {
                    const statusConfig = MEDICAO_STATUS_COLORS[med.status];
                    const StatusIcon = statusConfig?.icon || Clock;
                    return (
                      <motion.div
                        key={med.id}
                        initial={{ opacity: 0, x: -20 }}
                        animate={{ opacity: 1, x: 0 }}
                        transition={{ delay: idx * 0.05 }}
                        className={`p-4 rounded-xl border ${statusConfig?.bg || 'bg-slate-800/50'} border-slate-700/50`}
                      >
                        <div className="flex items-start justify-between">
                          <div className="flex items-center gap-3">
                            <div className={`p-2 ${statusConfig?.bg} rounded-lg`}>
                              <StatusIcon className={`w-5 h-5 ${statusConfig?.text}`} />
                            </div>
                            <div>
                              <div className="flex items-center gap-2">
                                <span className="text-white font-medium">Medição #{med.numero}</span>
                                <span className={`px-2 py-0.5 text-xs rounded-full ${statusConfig?.bg} ${statusConfig?.text}`}>
                                  {med.etapa === ETAPA_MEDICAO.FABRICACAO ? 'Fabricação' : 'Montagem'}
                                </span>
                              </div>
                              <p className="text-sm text-slate-400">
                                {med.setor} • {(med.pesoMedido / 1000).toFixed(2)} ton
                              </p>
                            </div>
                          </div>

                          <div className="text-right">
                            <p className="text-lg font-bold text-white">
                              R$ {(med.valorBruto || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                            </p>
                            <p className="text-xs text-slate-400">
                              Líquido: R$ {(med.valorLiquido || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                            </p>
                          </div>
                        </div>

                        {/* Detalhamento */}
                        <div className="mt-3 pt-3 border-t border-slate-700/50 grid grid-cols-5 gap-2">
                          {Object.entries(med.detalhamento).map(([etapa, dados]) => (
                            <div key={etapa} className="text-center">
                              <p className="text-xs text-slate-500 capitalize">{etapa}</p>
                              <p className="text-sm text-white">R$ {(dados.valor / 1000).toFixed(1)}k</p>
                            </div>
                          ))}
                        </div>

                        {/* Retenções */}
                        <div className="mt-2 flex items-center gap-4 text-xs text-slate-500">
                          <span>ISS: R$ {((med.retencoes?.iss) || 0).toFixed(2)}</span>
                          <span>INSS: R$ {((med.retencoes?.inss) || 0).toFixed(2)}</span>
                          <span>Contratual: R$ {((med.retencoes?.contratual) || 0).toFixed(2)}</span>
                        </div>
                      </motion.div>
                    );
                  })}
                </div>
              </div>

              {/* Resumo de Medições */}
              <div className="space-y-4">
                {/* Valores Disponíveis */}
                <div className="bg-gradient-to-br from-purple-900/30 to-pink-900/30 backdrop-blur-xl
                              rounded-xl border border-purple-500/30 p-5">
                  <h4 className="text-sm font-medium text-purple-300 mb-3 flex items-center gap-2">
                    <Info className="w-4 h-4" />
                    Valores Disponíveis para Medição
                  </h4>

                  <div className="space-y-3">
                    <div className="bg-slate-800/50 rounded-lg p-3">
                      <p className="text-xs text-slate-400">Fabricação (após EXPEDIDO)</p>
                      <p className="text-xl font-bold text-purple-400">
                        R$ {((saldo.saldoAMedir * 0.65) / 1000).toFixed(0)}k
                      </p>
                      <p className="text-xs text-slate-500">~65% do saldo</p>
                    </div>

                    <div className="bg-slate-800/50 rounded-lg p-3">
                      <p className="text-xs text-slate-400">Montagem (após MONTADO)</p>
                      <p className="text-xl font-bold text-emerald-400">
                        R$ {((saldo.saldoAMedir * 0.35) / 1000).toFixed(0)}k
                      </p>
                      <p className="text-xs text-slate-500">~35% do saldo</p>
                    </div>
                  </div>
                </div>

                {/* R$/kg por Etapa */}
                <div className="bg-gradient-to-br from-slate-800/80 to-slate-900/80 backdrop-blur-xl
                              rounded-xl border border-slate-700/50 p-5">
                  <h4 className="text-sm font-medium text-white mb-3">Valores por Kg</h4>

                  <div className="space-y-2">
                    <div className="flex justify-between">
                      <span className="text-slate-400 text-sm">Corte</span>
                      <span className="text-white font-medium">R$ 2,50/kg</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-slate-400 text-sm">Fabricação</span>
                      <span className="text-white font-medium">R$ 4,00/kg</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-slate-400 text-sm">Solda</span>
                      <span className="text-white font-medium">R$ 3,00/kg</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-slate-400 text-sm">Pintura</span>
                      <span className="text-white font-medium">R$ 1,80/kg</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-slate-400 text-sm">Expedição</span>
                      <span className="text-white font-medium">R$ 0,50/kg</span>
                    </div>
                    <div className="flex justify-between pt-2 border-t border-slate-700/50">
                      <span className="text-cyan-400 text-sm font-medium">Total Fabricação</span>
                      <span className="text-cyan-400 font-bold">R$ 11,80/kg</span>
                    </div>
                    <div className="flex justify-between pt-2 border-t border-slate-700/50">
                      <span className="text-emerald-400 text-sm font-medium">Total Montagem</span>
                      <span className="text-emerald-400 font-bold">R$ 6,40/kg</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </Tabs.Content>

          {/* Tab: Por Setor */}
          <Tabs.Content value="setores" className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {obra.setores.map((setor, idx) => {
                const despesasSetor = lancamentos.filter(l => l.setor === setor.nome);
                const totalDespesasSetor = despesasSetor.reduce((s, l) => s + l.valor, 0);
                const medicoesSetor = medicoes.filter(m => m.setor === setor.nome);
                const totalMedidoSetor = medicoesSetor.reduce((s, m) => s + m.valorBruto, 0);
                const pesoMedidoSetor = medicoesSetor.reduce((s, m) => s + m.pesoMedido, 0);

                return (
                  <motion.div
                    key={setor.id}
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: idx * 0.1 }}
                    className="bg-gradient-to-br from-slate-800/80 to-slate-900/80 backdrop-blur-xl
                              rounded-xl border border-slate-700/50 p-5"
                  >
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-3">
                        <div className="w-12 h-12 bg-gradient-to-br from-cyan-500 to-teal-600
                                      rounded-xl flex items-center justify-center text-white font-bold">
                          {setor.nome.slice(0, 2)}
                        </div>
                        <div>
                          <h4 className="text-white font-medium">{setor.nome}</h4>
                          <p className="text-xs text-slate-400">{(setor.peso / 1000).toFixed(2)} ton</p>
                        </div>
                      </div>
                    </div>

                    {/* Valores */}
                    <div className="space-y-3">
                      <div className="flex justify-between">
                        <span className="text-slate-400 text-sm">Valor Contrato</span>
                        <span className="text-white font-medium">
                          R$ {(setor.valor / 1000).toFixed(0)}k
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-slate-400 text-sm">Total Despesas</span>
                        <span className="text-red-400 font-medium">
                          R$ {(totalDespesasSetor / 1000).toFixed(0)}k
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-slate-400 text-sm">Total Medido</span>
                        <span className="text-cyan-400 font-medium">
                          R$ {(totalMedidoSetor / 1000).toFixed(0)}k
                        </span>
                      </div>
                      <div className="flex justify-between pt-2 border-t border-slate-700/50">
                        <span className="text-slate-400 text-sm">Saldo Setor</span>
                        <span className={`font-bold ${setor.valor - totalMedidoSetor >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                          R$ {((setor.valor - totalMedidoSetor) / 1000).toFixed(0)}k
                        </span>
                      </div>
                    </div>

                    {/* Progresso */}
                    <div className="mt-4">
                      <div className="flex justify-between text-xs text-slate-400 mb-1">
                        <span>Peso Medido</span>
                        <span>{(pesoMedidoSetor || 0).toLocaleString()} / {(setor.peso || 0).toLocaleString()} kg</span>
                      </div>
                      <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                        <motion.div
                          initial={{ width: 0 }}
                          animate={{ width: `${((pesoMedidoSetor || 0) / (setor.peso || 1)) * 100}%` }}
                          className="h-full bg-gradient-to-r from-cyan-500 to-teal-500 rounded-full"
                        />
                      </div>
                      <p className="text-xs text-slate-500 mt-1 text-right">
                        {((((pesoMedidoSetor || 0) / (setor.peso || 1)) * 100) || 0).toFixed(1)}% medido
                      </p>
                    </div>

                    {/* R$/kg */}
                    <div className="mt-4 p-3 bg-slate-800/50 rounded-lg">
                      <div className="flex justify-between">
                        <span className="text-slate-400 text-sm">R$/kg Contrato</span>
                        <span className="text-white font-medium">R$ {((setor.precoKg || 0).toFixed(2))}</span>
                      </div>
                      <div className="flex justify-between mt-1">
                        <span className="text-slate-400 text-sm">R$/kg Realizado</span>
                        <span className={`font-medium ${((pesoMedidoSetor || 0) > 0 ? (totalDespesasSetor || 0) / (pesoMedidoSetor || 1) : 0) <= (setor.precoKg || 0) ? 'text-emerald-400' : 'text-red-400'}`}>
                          R$ {(pesoMedidoSetor || 0) > 0 ? (((totalDespesasSetor || 0) / (pesoMedidoSetor || 1)) || 0).toFixed(2) : '0.00'}
                        </span>
                      </div>
                    </div>
                  </motion.div>
                );
              })}
            </div>
          </Tabs.Content>

          {/* Tab: Fluxo de Caixa */}
          <Tabs.Content value="fluxo" className="space-y-4">
            <div className="bg-gradient-to-br from-slate-800/80 to-slate-900/80 backdrop-blur-xl
                          rounded-xl border border-slate-700/50 p-5">
              <h3 className="text-lg font-semibold text-white flex items-center gap-2 mb-4">
                <Activity className="w-5 h-5 text-amber-400" />
                Fluxo de Caixa - Próximos 6 Meses
              </h3>

              <ResponsiveContainer width="100%" height={350}>
                <ComposedChart data={fluxoCaixa}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                  <XAxis dataKey="mesLabel" stroke="#64748b" fontSize={12} />
                  <YAxis stroke="#64748b" fontSize={12} tickFormatter={(v) => `R$ ${formatMoneyShort(v)}`} />
                  <Tooltip
                    contentStyle={{ backgroundColor: '#1e293b', border: '1px solid #334155', borderRadius: '8px' }}
                    formatter={(value, name) => [`R$ ${(value / 1000).toFixed(0)}k`, name]}
                  />
                  <Bar dataKey="receitas" name="Receitas Previstas" fill="#10b981" radius={[4, 4, 0, 0]} />
                  <Bar dataKey="despesas" name="Despesas Previstas" fill="#ef4444" radius={[4, 4, 0, 0]} />
                  <Line type="monotone" dataKey="saldo" name="Saldo Projetado" stroke="#06b6d4" strokeWidth={3} dot={{ fill: '#06b6d4' }} />
                </ComposedChart>
              </ResponsiveContainer>

              {/* Tabela de Fluxo */}
              <div className="mt-6 overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="text-xs text-slate-400 border-b border-slate-700/50">
                      <th className="text-left py-2 px-3">Mês</th>
                      <th className="text-right py-2 px-3">Receitas</th>
                      <th className="text-right py-2 px-3">Despesas</th>
                      <th className="text-right py-2 px-3">Saldo</th>
                    </tr>
                  </thead>
                  <tbody>
                    {fluxoCaixa.map((mes, idx) => (
                      <tr key={idx} className="border-b border-slate-700/30">
                        <td className="py-2 px-3 text-white">{mes.mesLabel}</td>
                        <td className="py-2 px-3 text-right text-emerald-400">
                          R$ {(mes.receitas / 1000).toFixed(0)}k
                        </td>
                        <td className="py-2 px-3 text-right text-red-400">
                          R$ {(mes.despesas / 1000).toFixed(0)}k
                        </td>
                        <td className={`py-2 px-3 text-right font-medium ${mes.saldo >= 0 ? 'text-cyan-400' : 'text-red-400'}`}>
                          R$ {(mes.saldo / 1000).toFixed(0)}k
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </Tabs.Content>
        </Tabs.Root>

        {/* Modal Novo Lançamento */}
        <Dialog.Root open={showNovoLancamento} onOpenChange={setShowNovoLancamento}>
          <Dialog.Portal>
            <Dialog.Overlay className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50" />
            <Dialog.Content className="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2
                                      w-full max-w-lg bg-slate-800 border border-slate-700
                                      rounded-2xl p-6 z-50">
              <Dialog.Title className="text-xl font-bold text-white mb-4">
                Novo Lançamento
              </Dialog.Title>

              <NovoLancamentoForm
                categorias={CATEGORIA_DESPESA}
                setores={obra.setores}
                onSubmit={adicionarLancamento}
                onCancel={() => setShowNovoLancamento(false)}
              />
            </Dialog.Content>
          </Dialog.Portal>
        </Dialog.Root>
      </div>
    </div>
  );
}

// Componente de Formulário de Novo Lançamento
function NovoLancamentoForm({ categorias, setores, onSubmit, onCancel }) {
  const [formData, setFormData] = useState({
    tipo: TIPO_LANCAMENTO.DESPESA,
    categoria: CATEGORIA_DESPESA.MATERIAL_ESTRUTURA,
    descricao: '',
    fornecedor: '',
    notaFiscal: '',
    dataEmissao: new Date().toISOString().split('T')[0],
    dataVencimento: '',
    valor: 0,
    setor: ''
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.descricao || !formData.valor) return;
    onSubmit(formData);
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="text-sm text-slate-400 mb-1 block">Tipo</label>
          <Select.Root value={formData.tipo} onValueChange={(v) => setFormData({ ...formData, tipo: v })}>
            <Select.Trigger className="w-full flex items-center justify-between px-3 py-2
                                     bg-slate-700/50 border border-slate-600 rounded-lg text-white text-sm">
              <Select.Value />
              <ChevronDown className="w-4 h-4 text-slate-400" />
            </Select.Trigger>
            <Select.Portal>
              <Select.Content className="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden z-[60]">
                <Select.Viewport>
                  {Object.entries(TIPO_LANCAMENTO).map(([key, value]) => (
                    <Select.Item key={key} value={value} className="px-4 py-2 text-white hover:bg-slate-700 cursor-pointer text-sm">
                      <Select.ItemText>{key.split('_').join(' ')}</Select.ItemText>
                    </Select.Item>
                  ))}
                </Select.Viewport>
              </Select.Content>
            </Select.Portal>
          </Select.Root>
        </div>

        <div>
          <label className="text-sm text-slate-400 mb-1 block">Categoria</label>
          <Select.Root value={formData.categoria} onValueChange={(v) => setFormData({ ...formData, categoria: v })}>
            <Select.Trigger className="w-full flex items-center justify-between px-3 py-2
                                     bg-slate-700/50 border border-slate-600 rounded-lg text-white text-sm">
              <Select.Value />
              <ChevronDown className="w-4 h-4 text-slate-400" />
            </Select.Trigger>
            <Select.Portal>
              <Select.Content className="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden z-[60] max-h-60">
                <Select.Viewport>
                  {Object.entries(CATEGORIA_LABELS).map(([key, label]) => (
                    <Select.Item key={key} value={key} className="px-4 py-2 text-white hover:bg-slate-700 cursor-pointer text-sm">
                      <Select.ItemText>{label}</Select.ItemText>
                    </Select.Item>
                  ))}
                </Select.Viewport>
              </Select.Content>
            </Select.Portal>
          </Select.Root>
        </div>
      </div>

      <div>
        <label className="text-sm text-slate-400 mb-1 block">Descrição *</label>
        <input
          type="text"
          value={formData.descricao}
          onChange={(e) => setFormData({ ...formData, descricao: e.target.value })}
          required
          className="w-full px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg
                   text-white focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
        />
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="text-sm text-slate-400 mb-1 block">Fornecedor</label>
          <input
            type="text"
            value={formData.fornecedor}
            onChange={(e) => setFormData({ ...formData, fornecedor: e.target.value })}
            className="w-full px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg
                     text-white focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
          />
        </div>
        <div>
          <label className="text-sm text-slate-400 mb-1 block">Nota Fiscal</label>
          <input
            type="text"
            value={formData.notaFiscal}
            onChange={(e) => setFormData({ ...formData, notaFiscal: e.target.value })}
            className="w-full px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg
                     text-white focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
          />
        </div>
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="text-sm text-slate-400 mb-1 block">Data Emissão</label>
          <input
            type="date"
            value={formData.dataEmissao}
            onChange={(e) => setFormData({ ...formData, dataEmissao: e.target.value })}
            className="w-full px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg
                     text-white focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
          />
        </div>
        <div>
          <label className="text-sm text-slate-400 mb-1 block">Data Vencimento</label>
          <input
            type="date"
            value={formData.dataVencimento}
            onChange={(e) => setFormData({ ...formData, dataVencimento: e.target.value })}
            className="w-full px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg
                     text-white focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
          />
        </div>
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="text-sm text-slate-400 mb-1 block">Valor *</label>
          <input
            type="number"
            value={formData.valor}
            onChange={(e) => setFormData({ ...formData, valor: parseFloat(e.target.value) || 0 })}
            required
            step="0.01"
            className="w-full px-3 py-2 bg-slate-700/50 border border-slate-600 rounded-lg
                     text-white focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
          />
        </div>
        <div>
          <label className="text-sm text-slate-400 mb-1 block">Setor</label>
          <Select.Root value={formData.setor} onValueChange={(v) => setFormData({ ...formData, setor: v })}>
            <Select.Trigger className="w-full flex items-center justify-between px-3 py-2
                                     bg-slate-700/50 border border-slate-600 rounded-lg text-white text-sm">
              <Select.Value placeholder="Selecione" />
              <ChevronDown className="w-4 h-4 text-slate-400" />
            </Select.Trigger>
            <Select.Portal>
              <Select.Content className="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden z-[60]">
                <Select.Viewport>
                  {setores.map((setor) => (
                    <Select.Item key={setor.id} value={setor.nome} className="px-4 py-2 text-white hover:bg-slate-700 cursor-pointer text-sm">
                      <Select.ItemText>{setor.nome}</Select.ItemText>
                    </Select.Item>
                  ))}
                </Select.Viewport>
              </Select.Content>
            </Select.Portal>
          </Select.Root>
        </div>
      </div>

      <div className="flex items-center gap-3 pt-4">
        <button
          type="button"
          onClick={onCancel}
          className="flex-1 px-4 py-2 bg-slate-700 text-slate-300 rounded-xl
                   hover:bg-slate-600 transition-colors"
        >
          Cancelar
        </button>
        <button
          type="submit"
          className="flex-1 px-4 py-2 bg-gradient-to-r from-emerald-500 to-teal-600
                   text-white rounded-xl hover:from-emerald-600 hover:to-teal-700
                   transition-all font-medium"
        >
          Adicionar
        </button>
      </div>
    </form>
  );
}
